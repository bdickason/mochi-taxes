// Generated by CoffeeScript 1.4.0

/* Data models and interface with Mysql
*/


(function() {
  var Db, Mysql, cfg;

  Mysql = require('mysql');

  cfg = require('../cfg/config.js');

  exports.Db = Db = (function() {

    function Db(cfg) {
      this.mysql = Mysql.createConnection({
        host: "" + cfg.DB_HOSTNAME,
        port: "" + cfg.DB_PORT,
        user: "" + cfg.DB_USERNAME,
        password: "" + cfg.DB_PASSWORD,
        database: "" + cfg.DB_DATABASE
      });
      this.mysql.connect(function(err) {
        if (err) {
          return console.log("Error: " + err);
        }
      });
    }

    Db.prototype.getTransaction = function(id, callback) {
      var err;
      if (id) {
        return this.mysql.query("Select * FROM transactions WHERE transaction_id = " + id, function(err, rows) {
          if (err) {
            console.log("Error: " + err);
          }
          return callback(err, rows);
        });
      } else {
        err = "Error: No id defined";
        return callback(err, null);
      }
    };

    Db.prototype.getTaxByQuarter = function(startDate, endDate, callback) {
      var err;
      if (startDate && endDate) {
        return this.mysql.query("      SELECT te.transaction_entry_type as type, SUM( te.transaction_entry_price_added ) as total       FROM `transactions_entries` as te      INNER JOIN transactions as t      ON t.transaction_id = te.transaction_id      WHERE te.transaction_entry_date_added >= '" + startDate + "'      AND te.transaction_entry_date_added < '" + endDate + "'      AND t.transaction_void != 1      GROUP BY te.transaction_entry_type      ", function(err, rows) {
          if (err) {
            console.log('Error: ' + err);
          }
          return callback(err, rows);
        });
      } else {
        if (!startDate) {
          err = "Error: No start date defined";
        } else if (!endDate) {
          err = "Error: No end date defined";
        }
        return callback(err, null);
      }
    };

    Db.prototype.test = function(callback) {
      return this.mysql.query("SELECT 1", function(err, rows) {
        if (err) {
          console.log("Error: " + err);
        }
        return callback(err, rows);
      });
    };

    return Db;

  })();

}).call(this);
